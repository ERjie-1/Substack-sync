name: Sync Substack to Notion

on:
  # 定时运行（GitHub cron 使用 UTC；以下注释为北京时间/BJT）
  # 运行日：工作日 + 周日（BJT）；周六（BJT）仅 08:00 和 20:00
  schedule:
    # --- 每5小时一次（BJT 00:00/05:00/10:00/15:00；20:00 由晚间半小时窗口覆盖，避免重复）---
    # BJT 00:00 -> UTC 16:00 前一日（UTC 周六/周日/周一/周二/周三/周四）
    - cron: '0 16 * * 6,0-4'
    # BJT 05:00 -> UTC 21:00 前一日（UTC 周六/周日/周一/周二/周三/周四）
    - cron: '0 21 * * 6,0-4'
    # BJT 10:00 -> UTC 02:00 当日（UTC 周日/周一/周二/周三/周四/周五）
    - cron: '0 2 * * 0-5'
    # BJT 15:00 -> UTC 07:00 当日（UTC 周日/周一/周二/周三/周四/周五）
    - cron: '0 7 * * 0-5'

    # --- 早上 07:00-09:00 每30分钟（BJT）---
    # BJT 07:00/07:30 -> UTC 23:00/23:30 前一日（UTC 周六/周日/周一/周二/周三/周四）
    - cron: '0,30 23 * * 6,0-4'
    # BJT 08:00/08:30 -> UTC 00:00/00:30 当日（UTC 周日/周一/周二/周三/周四/周五）
    - cron: '0,30 0 * * 0-5'
    # BJT 09:00 -> UTC 01:00 当日（UTC 周日/周一/周二/周三/周四/周五）
    - cron: '0 1 * * 0-5'

    # --- 晚上 20:00-23:00 每30分钟（BJT）---
    # BJT 20:00-22:30 -> UTC 12:00-14:30 当日（UTC 周日/周一/周二/周三/周四/周五）
    - cron: '0,30 12-14 * * 0-5'
    # BJT 23:00 -> UTC 15:00 当日（UTC 周日/周一/周二/周三/周四/周五）
    - cron: '0 15 * * 0-5'

    # --- 周六（BJT）08:00 和 20:00 ---
    # BJT 周六 08:00 -> UTC 周六 00:00
    - cron: '0 0 * * 6'
    # BJT 周六 20:00 -> UTC 周六 12:00
    - cron: '0 12 * * 6'

  # 允许手动触发
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - prod
      max_emails:
        description: 'Maximum emails to fetch'
        required: false
        default: '50'

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'schedule' && 'prod' || github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run sync script
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NOTION_API_TOKEN_2: ${{ secrets.NOTION_API_TOKEN_2 }}
          NOTION_DATABASE_ID_2: ${{ secrets.NOTION_DATABASE_ID_2 }}
          GMAIL_TOKEN_BASE64: ${{ secrets.GMAIL_TOKEN_BASE64 }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ENABLE_TRANSLATION: 'true'
          MAX_EMAIL_LIMIT: ${{ github.event.inputs.max_emails || '50' }}
        run: |
          export GMAIL_TOKEN="$(echo "$GMAIL_TOKEN_BASE64" | base64 --decode)"
          python sync_substack.py
